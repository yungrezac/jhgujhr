<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0D0D0D;
            color: #ffffff;
        }
        .element-bg { background-color: #1E1E1E; }
        .dark-element-bg { background-color: #141414; }
        .gradient-accent { background-image: linear-gradient(to bottom left, #000000, #C38345); }
        .text-secondary { color: #8A8A8E; }
        .text-delete { color: #8A8A8E; }
        .text-logout { color: #8A8A8E; }
        .info-button-border { border: 1px solid #4A4A4A; }
        #avatar-modal, .modal-backdrop { transition: background-color 0.3s ease-in-out; }
        #modal-panel, .modal-panel {
            transition: transform 0.3s ease-in-out;
            overflow-y: hidden;
        }
        input.element-bg, .input-style {
            background-color: #1E1E1E;
            border: 1px solid #4A4A4A;
            outline: none;
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.75rem;
        }
        .avatar-glow { box-shadow: 0 0 25px 5px rgba(228, 167, 90, 0.3); }
        .modal-glow { box-shadow: 0 -5px 25px 5px rgba(228, 167, 90, 0.2); }
        .avatar-selected { border: 2px solid #D6A96A !important; }

        /* Calendar Styles */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { text-align: center; padding: 0.5rem; border-radius: 50%; cursor: pointer; }
        .calendar-day.other-month { color: #555; }
        .calendar-day:not(.other-month):hover { background-color: #333; }
        .calendar-day.selected { background-color: #D6A96A; color: #000; }
        .calendar-day.today { border: 1px solid #D6A96A; }
        
        /* Country list scrollbar */
        .country-list::-webkit-scrollbar { width: 4px; }
        .country-list::-webkit-scrollbar-thumb { background: #4A4A4A; border-radius: 2px; }
    </style>
</head>
<body class="antialiased">

    <div id="app-container" class="w-full min-h-screen flex flex-col bg-[#0D0D0D]">
        <!-- PROFILE PAGE -->
        <div id="profile-page" class="flex flex-col flex-grow">
            <main class="flex-grow p-4 flex flex-col">
                <header class="flex justify-between items-center mb-4">
                    <button class="w-10 h-10 flex items-center justify-center dark-element-bg rounded-full"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                    <button id="edit-profile-button" class="w-10 h-10 flex items-center justify-center dark-element-bg rounded-full"><i data-lucide="pencil" class="w-5 h-5 cursor-pointer"></i></button>
                </header>
                <div class="relative flex flex-col items-center text-center mb-4">
                    <div class="flex justify-center items-center gap-x-2.5 mb-4">
                        <div class="flex flex-col items-center space-y-1">
                            <div class="w-12 h-12 rounded-full dark-element-bg flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"></path><path d="M22 2L15 22L11 13L2 9L22 2z"></path></svg></div>
                            <span class="text-xs text-secondary">–ö–∞–Ω–∞–ª</span>
                        </div>
                        <div class="relative">
                            <div id="avatar-button" class="w-28 h-28 bg-cover bg-center bg-[#48484A] rounded-full cursor-pointer flex items-center justify-center border-2 border-[#EBEBF5]/30 avatar-glow"></div>
                            <button class="absolute bottom-0 right-0 element-bg w-7 h-7 rounded-full flex items-center justify-center border-2 border-[#0D0D0D]"><i data-lucide="plus" class="w-4 h-4 text-white"></i></button>
                        </div>
                        <div class="flex flex-col items-center space-y-1">
                            <div class="w-12 h-12 rounded-full dark-element-bg flex items-center justify-center"><i data-lucide="globe" class="w-6 h-6"></i></div>
                            <span class="text-xs text-secondary">–°–∞–π—Ç</span>
                        </div>
                    </div>
                    <div id="profile-details">
                        <p id="display-fullname" class="text-secondary text-sm">–§–ò–û</p>
                        <h1 id="display-nickname" class="text-2xl font-bold">kadetov</h1>
                    </div>
                    <i id="toggle-visibility-button" data-lucide="eye" class="w-6 h-6 text-secondary absolute top-0 right-0 cursor-pointer"></i>
                </div>
                <div id="profile-partner" class="element-bg text-center py-2 px-4 rounded-lg mb-4">
                    <p class="text-sm text-secondary">–ë–∏–∑–Ω–µ—Å-–ø–∞—Ä—Ç–Ω–µ—Ä: <span id="display-partner" class="text-white">–Ω–∏–∫—Ç–µ–ª–µ–≥—Ä–∞–º</span></p>
                </div>
                <div id="profile-stats" class="grid grid-cols-3 gap-3 text-center text-sm mb-6">
                    <div id="display-gender" class="p-3 rounded-xl gradient-accent text-white font-semibold">–ü–æ–ª</div>
                    <div id="display-age" class="info-button-border p-3 rounded-xl">–í–æ–∑—Ä–∞—Å—Ç</div>
                    <div class="info-button-border p-3 rounded-xl flex items-center justify-center space-x-2">
                        <span id="display-country-flag">üá∑üá∫</span>
                        <span id="display-country">–†–æ—Å—Å–∏—è</span>
                    </div>
                </div>
                <div class="space-y-2 mb-6">
                    <a href="#" class="flex items-center element-bg p-3 rounded-xl">
                        <img src="https://placehold.co/40x40/2E7D32/FFFFFF?text=$$" alt="[–ò–∫–æ–Ω–∫–∞ –≤—ã–≤–æ–¥–∞]" class="w-10 h-10 mr-3 rounded-lg">
                        <span>–í—ã–≤–æ–¥</span><i data-lucide="chevron-right" class="w-5 h-5 ml-auto text-secondary"></i>
                    </a>
                    <a href="#" class="flex items-center element-bg p-3 rounded-xl">
                         <img src="https://placehold.co/40x40/FFC107/000000?text=FLAG" alt="[–ò–∫–æ–Ω–∫–∞ —Å—Ç–∞—Ä—Ç–∞]" class="w-10 h-10 mr-3 rounded-lg">
                        <span>–°—Ç–∞—Ä—Ç</span><i data-lucide="chevron-right" class="w-5 h-5 ml-auto text-secondary"></i>
                    </a>
                    <a href="#" class="flex items-center element-bg p-3 rounded-xl">
                        <img src="https://placehold.co/40x40/1976D2/FFFFFF?text=?" alt="[–ò–∫–æ–Ω–∫–∞ FAQ]" class="w-10 h-10 mr-3 rounded-lg">
                        <span>FAQ</span><i data-lucide="chevron-right" class="w-5 h-5 ml-auto text-secondary"></i>
                    </a>
                    <a href="#" class="flex items-center element-bg p-3 rounded-xl">
                        <img src="https://placehold.co/40x40/D32F2F/FFFFFF?text=H" alt="[–ò–∫–æ–Ω–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏]" class="w-10 h-10 mr-3 rounded-lg">
                        <span>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span><i data-lucide="chevron-right" class="w-5 h-5 ml-auto text-secondary"></i>
                    </a>
                </div>
                <div class="mt-auto pt-4 flex justify-between items-center">
                    <a href="#" class="text-delete font-medium">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</a>
                    <a href="#" class="text-logout font-medium">–í—ã–π—Ç–∏</a>
                </div>
            </main>
        </div>
        
        <!-- EDIT PROFILE PAGE -->
        <div id="edit-profile-page" class="hidden flex-grow">
             <main class="flex-grow p-4 space-y-4">
                <header class="flex items-center space-x-4 mb-2">
                    <i id="back-to-profile-button" data-lucide="chevron-left" class="w-6 h-6 cursor-pointer"></i>
                    <h1 class="font-bold text-lg flex-grow">–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ –ü–†–û–§–ò–õ–¨</h1>
                </header>
                <section class="space-y-3">
                    <h2 class="text-secondary text-sm font-medium">–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
                    <input type="text" id="edit-nickname" class="input-style" placeholder="–ù–∏–∫–Ω–µ–π–º">
                    <input type="text" id="edit-fullname" class="input-style" placeholder="–§–ò–û">
                    <input type="email" id="edit-email" class="input-style" placeholder="–í–∞—à–∞ –ø–æ—á—Ç–∞">
                    <div class="grid grid-cols-3 gap-3 text-center text-sm">
                         <div id="open-gender-modal" class="element-bg p-3 rounded-xl text-secondary cursor-pointer">–ü–æ–ª</div>
                         <div id="open-age-modal" class="element-bg p-3 rounded-xl text-secondary cursor-pointer">–í–æ–∑—Ä–∞—Å—Ç</div>
                         <div id="open-country-modal" class="element-bg p-3 rounded-xl text-secondary cursor-pointer">–°—Ç—Ä–∞–Ω–∞</div>
                    </div>
                </section>
                <section class="space-y-3">
                    <h2 class="text-secondary text-sm font-medium">–î–∞–Ω–Ω—ã–µ –≤—Ö–æ–¥–∞</h2>
                    <input type="text" id="edit-partner" class="input-style" placeholder="–ë–∏–∑–Ω–µ—Å-–ø–∞—Ä—Ç–Ω–µ—Ä (–Ω–∏–∫—Ç–µ–ª–µ–≥—Ä–∞–º)">
                    <div class="element-bg p-3 rounded-xl flex justify-between items-center text-sm">
                        <span class="text-secondary">–ü–∞—Ä–æ–ª—å</span>
                        <div class="flex items-center space-x-3 text-secondary"><i data-lucide="eye-off" class="w-5 h-5"></i><i data-lucide="settings" class="w-5 h-5"></i></div>
                    </div>
                    <div id="open-pin-modal" class="element-bg p-3 rounded-xl flex justify-between items-center text-sm cursor-pointer">
                        <span class="text-secondary">Pin (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–π)</span>
                        <i data-lucide="settings" class="w-5 h-5 text-secondary"></i>
                    </div>
                </section>
                <section class="space-y-3">
                     <h2 class="text-secondary text-sm font-medium">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
                     <div id="open-card-modal" class="element-bg p-3 rounded-xl flex justify-between items-center text-sm cursor-pointer">
                        <span class="text-secondary">–ü—Ä–∏–≤—è–∑–∞—Ç—å –±–∞–Ω–∫–æ–≤—Å–∫—É—é –∫–∞—Ä—Ç—É</span>
                        <div class="flex items-center space-x-2">
                            <img src="https://placehold.co/30x20/ffffff/000000?text=–ú–ò–†" alt="[–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –ú–ò–†]" class="h-4">
                            <img src="https://placehold.co/30x20/1a1a72/ffffff?text=VISA" alt="[–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã VISA]" class="h-4">
                            <img src="https://placehold.co/30x20/eb001b/f79e1b?text=MC" alt="[–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã Mastercard]" class="h-4">
                        </div>
                    </div>
                </section>
                <div class="grid grid-cols-2 gap-4 pt-4">
                    <button id="cancel-edit-button" class="element-bg text-white py-3 rounded-xl font-semibold">–û–¢–ú–ï–ù–ò–¢–¨</button>
                    <button id="save-profile-button" class="gradient-accent text-black py-3 rounded-xl font-semibold">–°–û–•–†–ê–ù–ò–¢–¨</button>
                </div>
             </main>
        </div>
    </div>

    <!-- MODALS -->
    <!-- Avatar Modal -->
    <div id="avatar-modal" class="fixed inset-0 bg-black bg-opacity-0 pointer-events-none flex justify-center items-end z-50">
        <div id="modal-panel" class="bg-[#1C1C1E] w-full rounded-t-2xl p-4 text-center transform translate-y-full flex flex-col modal-glow" style="height: 60vh;">
            <div class="flex-shrink-0"><h2 class="text-lg font-bold mb-1">–°–ú–ï–ù–ê –ê–í–ê–¢–ê–†–ê</h2><p class="text-secondary text-sm mb-4">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä</p></div>
            <div class="flex-grow overflow-y-auto py-4"><div id="avatar-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 content-start"></div></div>
            <input type="file" id="avatar-upload-input" class="hidden" accept="image/*">
            <div class="flex-shrink-0 grid grid-cols-2 gap-3 pt-4 border-t border-gray-700">
                <button id="cancel-modal-button" class="element-bg text-white py-2.5 rounded-xl font-semibold">–û–¢–ú–ï–ù–ò–¢–¨</button>
                <button id="save-avatar-button" class="gradient-accent text-black py-2.5 rounded-xl font-semibold">–°–û–•–†–ê–ù–ò–¢–¨</button>
            </div>
        </div>
    </div>
    <!-- Gender Modal -->
    <div id="gender-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center">
        <div class="modal-panel bg-[#1C1C1E] rounded-2xl p-6 w-11/12 max-w-xs space-y-4">
            <h3 class="text-lg font-bold text-center">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª</h3>
            <button data-value="–ú—É–∂—Å–∫–æ–π" class="gender-option w-full element-bg p-3 rounded-xl">–ú—É–∂—Å–∫–æ–π</button>
            <button data-value="–ñ–µ–Ω—Å–∫–∏–π" class="gender-option w-full element-bg p-3 rounded-xl">–ñ–µ–Ω—Å–∫–∏–π</button>
            <button data-value="–î—Ä—É–≥–æ–π" class="gender-option w-full element-bg p-3 rounded-xl">–î—Ä—É–≥–æ–π</button>
        </div>
    </div>
    <!-- Age/Calendar Modal -->
    <div id="age-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center">
        <div class="modal-panel bg-[#1C1C1E] rounded-2xl p-4 w-11/12 max-w-sm">
            <div id="calendar-header" class="flex justify-between items-center mb-4">
                <button id="prev-month"><i data-lucide="chevron-left"></i></button>
                <h3 id="month-year" class="font-bold text-lg"></h3>
                <button id="next-month"><i data-lucide="chevron-right"></i></button>
            </div>
            <div class="calendar-grid text-sm mb-4">
                <div>–í—Å</div><div>–ü–Ω</div><div>–í—Ç</div><div>–°—Ä</div><div>–ß—Ç</div><div>–ü—Ç</div><div>–°–±</div>
            </div>
            <div id="calendar-days" class="calendar-grid"></div>
        </div>
    </div>
    <!-- Country Modal -->
    <div id="country-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center">
        <div class="modal-panel bg-[#1C1C1E] rounded-2xl p-4 w-11/12 max-w-md flex flex-col" style="height: 80vh;">
            <h3 class="text-lg font-bold text-center mb-4">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É</h3>
            <input type="text" id="country-search" class="input-style mb-4" placeholder="–ü–æ–∏—Å–∫...">
            <div id="country-list" class="flex-grow overflow-y-auto country-list text-left"></div>
        </div>
    </div>
    <!-- PIN Modal -->
    <div id="pin-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center">
        <div class="modal-panel bg-[#1C1C1E] rounded-2xl p-6 w-11/12 max-w-xs space-y-4">
            <h3 class="text-lg font-bold text-center">–°–æ–∑–¥–∞—Ç—å PIN-–∫–æ–¥</h3>
            <input type="password" id="pin-input" class="input-style text-center tracking-[1em]" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4">
            <input type="password" id="pin-confirm-input" class="input-style text-center tracking-[1em]" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4">
            <button id="save-pin-button" class="w-full gradient-accent text-black p-3 rounded-xl font-semibold">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
    <!-- Card Modal -->
    <div id="card-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center">
        <div class="modal-panel bg-[#1C1C1E] rounded-2xl p-6 w-11/12 max-w-sm space-y-4">
            <h3 class="text-lg font-bold text-center">–î–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã</h3>
            <input type="text" id="card-number" class="input-style" placeholder="–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã">
            <div class="grid grid-cols-2 gap-4">
                <input type="text" id="card-expiry" class="input-style" placeholder="–ú–ú/–ì–ì">
                <input type="text" id="card-cvc" class="input-style" placeholder="CVC">
            </div>
            <button id="save-card-button" class="w-full gradient-accent text-black p-3 rounded-xl font-semibold">–ü—Ä–∏–≤—è–∑–∞—Ç—å</button>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- DOM Elements ---
        const profilePage = document.getElementById('profile-page');
        const editProfilePage = document.getElementById('edit-profile-page');
        const editProfileButton = document.getElementById('edit-profile-button');
        const backToProfileButton = document.getElementById('back-to-profile-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const saveProfileButton = document.getElementById('save-profile-button');
        
        const avatarButton = document.getElementById('avatar-button');
        const avatarModal = document.getElementById('avatar-modal');
        const modalPanel = document.getElementById('modal-panel');
        const cancelModalButton = document.getElementById('cancel-modal-button');
        const saveAvatarButton = document.getElementById('save-avatar-button');
        const avatarUploadInput = document.getElementById('avatar-upload-input');
        const avatarGrid = document.getElementById('avatar-grid');
        const toggleVisibilityButton = document.getElementById('toggle-visibility-button');

        const profileDetails = document.getElementById('profile-details');
        const profilePartner = document.getElementById('profile-partner');
        const profileStats = document.getElementById('profile-stats');
        const displayFullname = document.getElementById('display-fullname');
        const displayNickname = document.getElementById('display-nickname');
        const displayPartner = document.getElementById('display-partner');
        const displayGender = document.getElementById('display-gender');
        const displayAge = document.getElementById('display-age');
        const displayCountry = document.getElementById('display-country');
        const displayCountryFlag = document.getElementById('display-country-flag');

        const editFullname = document.getElementById('edit-fullname');
        const editNickname = document.getElementById('edit-nickname');
        const editEmail = document.getElementById('edit-email');
        const editPartner = document.getElementById('edit-partner');
        
        // Modal Triggers
        const openGenderModalBtn = document.getElementById('open-gender-modal');
        const openAgeModalBtn = document.getElementById('open-age-modal');
        const openCountryModalBtn = document.getElementById('open-country-modal');
        const openPinModalBtn = document.getElementById('open-pin-modal');
        const openCardModalBtn = document.getElementById('open-card-modal');

        // --- State & Local Storage ---
        const USER_DATA_KEY = 'userProfileData';
        let selectedAvatarInModal = null;
        let currentDate = new Date();

        function loadUserData() {
            const data = localStorage.getItem(USER_DATA_KEY);
            const defaultData = {
                fullname: '–§–ò–û', nickname: 'kadetov', email: '–í–∞—à–∞ –ø–æ—á—Ç–∞',
                partner: '–Ω–∏–∫—Ç–µ–ª–µ–≥—Ä–∞–º', gender: '–ü–æ–ª', age: '–í–æ–∑—Ä–∞—Å—Ç',
                country: '–†–æ—Å—Å–∏—è', country_flag: 'üá∑üá∫',
                avatar: 'https://placehold.co/112x112/222/FFF?text=',
                avatarHistory: ['https://placehold.co/112x112/222/FFF?text='],
                isProfileVisible: true, pin: '', card: {}
            };
            if (data) {
                const parsed = JSON.parse(data);
                return {...defaultData, ...parsed};
            }
            return defaultData;
        }

        function saveUserData(data) {
            localStorage.setItem(USER_DATA_KEY, JSON.stringify(data));
        }

        // --- UI Update Functions ---
        function updateUI() {
            const userData = loadUserData();
            displayFullname.textContent = userData.fullname;
            displayNickname.textContent = userData.nickname;
            displayPartner.textContent = userData.partner;
            displayGender.textContent = userData.gender;
            displayAge.textContent = userData.age;
            displayCountry.textContent = userData.country;
            displayCountryFlag.textContent = userData.country_flag;
            avatarButton.style.backgroundImage = `url('${userData.avatar}')`;
            
            editFullname.value = userData.fullname;
            editNickname.value = userData.nickname;
            editEmail.value = userData.email;
            editPartner.value = userData.partner;

            openGenderModalBtn.textContent = userData.gender;
            openAgeModalBtn.textContent = userData.age;
            openCountryModalBtn.textContent = userData.country;

            const isVisible = userData.isProfileVisible;
            profileDetails.classList.toggle('hidden', !isVisible);
            profilePartner.classList.toggle('hidden', !isVisible);
            profileStats.classList.toggle('hidden', !isVisible);
            toggleVisibilityButton.setAttribute('data-lucide', isVisible ? 'eye' : 'eye-off');
            lucide.createIcons({ nodes: [toggleVisibilityButton] });
        }

        // --- Page Switching ---
        function showProfilePage() {
            profilePage.classList.remove('hidden');
            profilePage.classList.add('flex');
            editProfilePage.classList.add('hidden');
            editProfilePage.classList.remove('flex');
            updateUI();
        }

        function showEditProfilePage() {
            profilePage.classList.add('hidden');
            profilePage.classList.remove('flex');
            editProfilePage.classList.remove('hidden');
            editProfilePage.classList.add('flex', 'flex-col');
            updateUI();
        }

        // --- Generic Modal Logic ---
        function openModal(modalId) { document.getElementById(modalId).classList.remove('hidden'); }
        function closeModal(modalId) { document.getElementById(modalId).classList.add('hidden'); }

        // --- Avatar Modal Logic ---
        function renderAvatarGrid() { /* ... same as before ... */ }
        // ... (avatar functions are complex and remain mostly the same)

        // --- Gender Modal Logic ---
        openGenderModalBtn.addEventListener('click', () => openModal('gender-modal'));
        document.querySelectorAll('.gender-option').forEach(btn => {
            btn.addEventListener('click', () => {
                const userData = loadUserData();
                userData.gender = btn.dataset.value;
                saveUserData(userData);
                updateUI();
                closeModal('gender-modal');
            });
        });

        // --- Calendar Modal Logic ---
        const monthYearEl = document.getElementById('month-year');
        const calendarDaysEl = document.getElementById('calendar-days');
        
        function renderCalendar() {
            calendarDaysEl.innerHTML = '';
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            monthYearEl.textContent = `${currentDate.toLocaleString('ru', { month: 'long' })} ${year}`;
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                calendarDaysEl.insertAdjacentHTML('beforeend', `<div></div>`);
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.textContent = i;
                dayEl.addEventListener('click', () => {
                    const selectedDate = new Date(year, month, i);
                    const age = new Date().getFullYear() - selectedDate.getFullYear();
                    const userData = loadUserData();
                    userData.age = age;
                    saveUserData(userData);
                    updateUI();
                    closeModal('age-modal');
                });
                calendarDaysEl.appendChild(dayEl);
            }
        }
        openAgeModalBtn.addEventListener('click', () => {
            renderCalendar();
            openModal('age-modal');
        });
        document.getElementById('prev-month').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });
        document.getElementById('next-month').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        // --- Country Modal Logic ---
        const countryListEl = document.getElementById('country-list');
        const countrySearchEl = document.getElementById('country-search');
        let countries = [];

        async function fetchCountries() {
            // In a real app, fetch from an API. Here's a sample.
            countries = [
                { name: '–†–æ—Å—Å–∏—è', flag: 'üá∑üá∫' }, { name: '–°–®–ê', flag: 'üá∫üá∏' },
                { name: '–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω', flag: 'üá∞üáø' }, { name: '–ë–µ–ª–∞—Ä—É—Å—å', flag: 'üáßüáæ' },
                { name: '–£–∫—Ä–∞–∏–Ω–∞', flag: 'üá∫üá¶' }, { name: '–ì–µ—Ä–º–∞–Ω–∏—è', flag: 'üá©üá™' },
                // ... add many more countries
            ];
            renderCountries();
        }

        function renderCountries(filter = '') {
            countryListEl.innerHTML = '';
            const filtered = countries.filter(c => c.name.toLowerCase().includes(filter.toLowerCase()));
            filtered.forEach(country => {
                const countryEl = document.createElement('div');
                countryEl.className = 'p-2 hover:bg-[#333] cursor-pointer rounded-lg flex items-center';
                countryEl.innerHTML = `<span class="mr-4">${country.flag}</span><span>${country.name}</span>`;
                countryEl.addEventListener('click', () => {
                    const userData = loadUserData();
                    userData.country = country.name;
                    userData.country_flag = country.flag;
                    saveUserData(userData);
                    updateUI();
                    closeModal('country-modal');
                });
                countryListEl.appendChild(countryEl);
            });
        }
        openCountryModalBtn.addEventListener('click', () => openModal('country-modal'));
        countrySearchEl.addEventListener('input', (e) => renderCountries(e.target.value));

        // --- PIN & Card Modals ---
        openPinModalBtn.addEventListener('click', () => openModal('pin-modal'));
        openCardModalBtn.addEventListener('click', () => openModal('card-modal'));
        // Logic for saving PIN and Card data would go here
        
        // --- Event Listeners ---
        editProfileButton.addEventListener('click', showEditProfilePage);
        backToProfileButton.addEventListener('click', showProfilePage);
        cancelEditButton.addEventListener('click', showProfilePage);
        avatarButton.addEventListener('click', () => openModal('avatar-modal'));
        cancelModalButton.addEventListener('click', () => closeModal('avatar-modal'));

        saveProfileButton.addEventListener('click', () => {
            const userData = loadUserData();
            userData.fullname = document.getElementById('edit-fullname').value;
            userData.nickname = document.getElementById('edit-nickname').value;
            userData.email = document.getElementById('edit-email').value;
            userData.partner = document.getElementById('edit-partner').value;
            saveUserData(userData);
            showProfilePage();
        });
        
        toggleVisibilityButton.addEventListener('click', () => {
            const userData = loadUserData();
            userData.isProfileVisible = !userData.isProfileVisible;
            saveUserData(userData);
            updateUI();
        });

        // Close modals with a click outside
        ['gender-modal', 'age-modal', 'country-modal', 'pin-modal', 'card-modal'].forEach(id => {
            document.getElementById(id).addEventListener('click', (e) => {
                if (e.target.id === id) closeModal(id);
            });
        });

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            updateUI();
            fetchCountries();
            // All other init logic like avatar grid rendering
        });
        
        // Simplified avatar logic for brevity
        function initAvatarLogic() {
            const saveAvatarButton = document.getElementById('save-avatar-button');
            const avatarUploadInput = document.getElementById('avatar-upload-input');
            const avatarGrid = document.getElementById('avatar-grid');
            
            function renderAvatarGrid() {
                const userData = loadUserData();
                avatarGrid.innerHTML = '';
                userData.avatarHistory.forEach(url => {
                    const div = document.createElement('div');
                    div.className = 'aspect-square rounded-full bg-cover bg-center cursor-pointer border-2 border-transparent';
                    if (url === selectedAvatarInModal) div.classList.add('avatar-selected');
                    div.style.backgroundImage = `url('${url}')`;
                    div.onclick = () => { selectedAvatarInModal = url; renderAvatarGrid(); };
                    avatarGrid.appendChild(div);
                });
                const uploadBtn = document.createElement('div');
                uploadBtn.className = 'aspect-square rounded-full border-2 border-dashed border-gray-600 flex flex-col items-center justify-center cursor-pointer p-2';
                uploadBtn.innerHTML = `<i data-lucide="plus" class="w-8 h-8 text-secondary"></i>`;
                uploadBtn.onclick = () => avatarUploadInput.click();
                avatarGrid.appendChild(uploadBtn);
                lucide.createIcons({nodes: [uploadBtn.querySelector('i')]});
            }

            avatarUploadInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (re) => {
                    const url = re.target.result;
                    const data = loadUserData();
                    if (!data.avatarHistory.includes(url)) {
                        data.avatarHistory.unshift(url);
                    }
                    selectedAvatarInModal = url;
                    saveUserData(data);
                    renderAvatarGrid();
                };
                reader.readAsDataURL(file);
            };

            saveAvatarButton.onclick = () => {
                if (selectedAvatarInModal) {
                    const data = loadUserData();
                    data.avatar = selectedAvatarInModal;
                    saveUserData(data);
                    updateUI();
                }
                closeModal('avatar-modal');
            };
            
            // Initial call when modal opens
            const originalOpenModal = window.openModal;
            window.openModal = (id) => {
                if (id === 'avatar-modal') {
                    selectedAvatarInModal = loadUserData().avatar;
                    renderAvatarGrid();
                }
                document.getElementById(id).classList.remove('hidden');
            };
        }
        initAvatarLogic();

    </script>
</body>
</html>
