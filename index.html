<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0D0D0D;
            color: #ffffff;
        }
        .element-bg { background-color: #1E1E1E; }
        .dark-element-bg { background-color: #141414; }
        .gradient-accent { background-image: linear-gradient(to top right, #000000, #C38345); }
        .solid-accent-button { background-color: #C38345; }
        .text-secondary { color: #8A8A8E; }
        .text-delete { color: #8A8A8E; }
        .text-logout { color: #8A8A8E; }
        .info-button-border { border: 1px solid #4A4A4A; }
        .gradient-border { border: 1px solid #C38345; }
        
        .avatar-glow { box-shadow: 0 0 30px 8px rgba(228, 167, 90, 0.5); }
        .modal-glow { box-shadow: 0 -5px 25px 5px rgba(228, 167, 90, 0.2); }
        .avatar-selected { border: 2px solid #D6A96A !important; }

        /* Generic Modal Styles */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0);
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Align all modals to the bottom for slide-up effect */
            pointer-events: none;
            transition: background-color 0.3s ease-in-out;
        }
        .modal-panel {
            background-color: #1C1C1E;
            width: 100%;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            max-height: 85vh;
        }
        .input-style {
            background-color: #1E1E1E;
            border: 1px solid #4A4A4A;
            outline: none;
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.75rem;
        }
        .input-style.error {
            border-color: #ef4444; /* red-500 */
        }

        /* Calendar Styles */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { text-align: center; padding: 0.5rem; border-radius: 50%; cursor: pointer; }
        .calendar-day.other-month { color: #555; }
        .calendar-day:not(.other-month):hover { background-color: #333; }
        .calendar-day.selected { background-color: #D6A96A; color: #000; }
        .calendar-day.today { border: 1px solid #D6A96A; }
        
        /* Country list scrollbar */
        .country-list::-webkit-scrollbar { width: 4px; }
        .country-list::-webkit-scrollbar-thumb { background: #4A4A4A; border-radius: 2px; }
        
        /* Custom select for calendar */
        .calendar-select {
            background-color: #1E1E1E;
            border: 1px solid #4A4A4A;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="antialiased">

    <div id="app-container" class="w-full min-h-screen flex flex-col bg-[#0D0D0D]">
        <!-- PROFILE PAGE -->
        <div id="profile-page" class="flex flex-col flex-grow">
            <main class="flex-grow p-4 flex flex-col">
                <header class="flex justify-between items-center mb-4">
                    <button class="w-10 h-10 flex items-center justify-center dark-element-bg rounded-full"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                    <button id="edit-profile-button" class="w-10 h-10 flex items-center justify-center dark-element-bg rounded-full"><i data-lucide="pencil" class="w-5 h-5 cursor-pointer"></i></button>
                </header>
                <div class="relative flex flex-col items-center text-center mb-4">
                    <div class="flex justify-center items-center gap-x-2.5 mb-4">
                        <div class="flex flex-col items-center space-y-1">
                            <div class="w-12 h-12 rounded-full dark-element-bg flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"></path><path d="M22 2L15 22L11 13L2 9L22 2z"></path></svg></div>
                            <span class="text-xs text-secondary">–ö–∞–Ω–∞–ª</span>
                        </div>
                        <div class="relative">
                            <div id="avatar-button" class="w-28 h-28 bg-cover bg-center bg-[#48484A] rounded-full cursor-pointer flex items-center justify-center border-2 border-[#C38345] avatar-glow"></div>
                            <button class="absolute bottom-0 right-0 element-bg w-7 h-7 rounded-full flex items-center justify-center border-2 border-[#0D0D0D]"><i data-lucide="plus" class="w-4 h-4 text-white"></i></button>
                        </div>
                        <div class="flex flex-col items-center space-y-1">
                            <div class="w-12 h-12 rounded-full dark-element-bg flex items-center justify-center"><i data-lucide="globe" class="w-6 h-6"></i></div>
                            <span class="text-xs text-secondary">–°–∞–π—Ç</span>
                        </div>
                    </div>
                    <div id="profile-details">
                        <p id="display-fullname" class="text-secondary text-sm">–§–ò–û</p>
                        <h1 id="display-nickname" class="text-2xl font-bold">kadetov</h1>
                    </div>
                    <i id="toggle-visibility-button" data-lucide="eye" class="w-6 h-6 text-secondary absolute top-0 right-0 cursor-pointer"></i>
                </div>
                <div id="profile-partner" class="element-bg text-center py-2 px-4 rounded-lg mb-4">
                    <p class="text-sm text-secondary">–ë–∏–∑–Ω–µ—Å-–ø–∞—Ä—Ç–Ω–µ—Ä: <span id="display-partner" class="text-white">–Ω–∏–∫—Ç–µ–ª–µ–≥—Ä–∞–º</span></p>
                </div>
                <div id="profile-stats" class="grid grid-cols-3 gap-3 text-center text-sm mb-6">
                    <div id="display-gender" class="p-3 rounded-xl gradient-accent text-white font-semibold">–ü–æ–ª</div>
                    <div id="display-age" class="gradient-border p-3 rounded-xl">–í–æ–∑—Ä–∞—Å—Ç</div>
                    <div class="gradient-border p-3 rounded-xl flex items-center justify-center space-x-2">
                        <span id="display-country-flag">üá∑üá∫</span>
                        <span id="display-country">–†–æ—Å—Å–∏—è</span>
                    </div>
                </div>
                <div class="space-y-2 mb-6">
                    <a href="#" class="flex items-center element-bg p-3 rounded-xl">
                        <img src="https://placehold.co/40x40/2E7D32/FFFFFF?text=$$" alt="[–ò–∫–æ–Ω–∫–∞ –≤—ã–≤–æ–¥–∞]" class="w-10 h-10 mr-3 rounded-lg">
                        <span>–í—ã–≤–æ–¥</span><i data-lucide="chevron-right" class="w-5 h-5 ml-auto text-secondary"></i>
                    </a>
                    <a href="#" class="flex items-center element-bg p-3 rounded-xl">
                         <img src="https://placehold.co/40x40/FFC107/000000?text=FLAG" alt="[–ò–∫–æ–Ω–∫–∞ —Å—Ç–∞—Ä—Ç–∞]" class="w-10 h-10 mr-3 rounded-lg">
                        <span>–°—Ç–∞—Ä—Ç</span><i data-lucide="chevron-right" class="w-5 h-5 ml-auto text-secondary"></i>
                    </a>
                    <a href="#" class="flex items-center element-bg p-3 rounded-xl">
                        <img src="https://placehold.co/40x40/1976D2/FFFFFF?text=?" alt="[–ò–∫–æ–Ω–∫–∞ FAQ]" class="w-10 h-10 mr-3 rounded-lg">
                        <span>FAQ</span><i data-lucide="chevron-right" class="w-5 h-5 ml-auto text-secondary"></i>
                    </a>
                    <a href="#" class="flex items-center element-bg p-3 rounded-xl">
                        <img src="https://placehold.co/40x40/D32F2F/FFFFFF?text=H" alt="[–ò–∫–æ–Ω–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏]" class="w-10 h-10 mr-3 rounded-lg">
                        <span>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span><i data-lucide="chevron-right" class="w-5 h-5 ml-auto text-secondary"></i>
                    </a>
                </div>
                <div class="mt-auto pt-4 flex justify-between items-center">
                    <a href="#" class="text-delete font-medium">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</a>
                    <a href="#" class="text-logout font-medium">–í—ã–π—Ç–∏</a>
                </div>
            </main>
        </div>
        
        <!-- EDIT PROFILE PAGE -->
        <div id="edit-profile-page" class="hidden flex-grow">
             <main class="flex-grow p-4 space-y-4">
                <header class="flex items-center space-x-4 mb-2">
                    <i id="back-to-profile-button" data-lucide="chevron-left" class="w-6 h-6 cursor-pointer"></i>
                    <h1 class="font-bold text-lg flex-grow">–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ –ü–†–û–§–ò–õ–¨</h1>
                </header>
                <section class="space-y-3">
                    <h2 class="text-secondary text-sm font-medium">–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
                    <input type="text" id="edit-nickname" class="input-style" placeholder="–ù–∏–∫–Ω–µ–π–º">
                    <input type="text" id="edit-fullname" class="input-style" placeholder="–§–ò–û">
                    <input type="email" id="edit-email" class="input-style" placeholder="–í–∞—à–∞ –ø–æ—á—Ç–∞">
                    <div class="grid grid-cols-3 gap-3 text-center text-sm">
                         <div id="open-gender-modal" class="element-bg p-3 rounded-xl text-secondary cursor-pointer">–ü–æ–ª</div>
                         <div id="open-age-modal" class="element-bg p-3 rounded-xl text-secondary cursor-pointer">–í–æ–∑—Ä–∞—Å—Ç</div>
                         <div id="open-country-modal" class="element-bg p-3 rounded-xl text-secondary cursor-pointer">–°—Ç—Ä–∞–Ω–∞</div>
                    </div>
                </section>
                <section class="space-y-3">
                    <h2 class="text-secondary text-sm font-medium">–î–∞–Ω–Ω—ã–µ –≤—Ö–æ–¥–∞</h2>
                    <input type="text" id="edit-partner" class="input-style" placeholder="–ë–∏–∑–Ω–µ—Å-–ø–∞—Ä—Ç–Ω–µ—Ä (–Ω–∏–∫—Ç–µ–ª–µ–≥—Ä–∞–º)">
                    <div class="element-bg p-3 rounded-xl flex justify-between items-center text-sm">
                        <span class="text-secondary">–ü–∞—Ä–æ–ª—å</span>
                        <div class="flex items-center space-x-3 text-secondary"><i data-lucide="eye-off" class="w-5 h-5"></i><i data-lucide="settings" class="w-5 h-5"></i></div>
                    </div>
                    <div id="open-pin-modal" class="element-bg p-3 rounded-xl flex justify-between items-center text-sm cursor-pointer">
                        <span class="text-secondary">Pin (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–π)</span>
                        <i data-lucide="settings" class="w-5 h-5 text-secondary"></i>
                    </div>
                </section>
                <section class="space-y-3">
                     <h2 class="text-secondary text-sm font-medium">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
                     <div id="open-card-modal" class="element-bg p-3 rounded-xl flex justify-between items-center text-sm cursor-pointer">
                        <span class="text-secondary">–ü—Ä–∏–≤—è–∑–∞—Ç—å –±–∞–Ω–∫–æ–≤—Å–∫—É—é –∫–∞—Ä—Ç—É</span>
                        <div class="flex items-center space-x-2">
                            <img src="https://placehold.co/30x20/ffffff/000000?text=–ú–ò–†" alt="[–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –ú–ò–†]" class="h-4">
                            <img src="https://placehold.co/30x20/1a1a72/ffffff?text=VISA" alt="[–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã VISA]" class="h-4">
                            <img src="https://placehold.co/30x20/eb001b/f79e1b?text=MC" alt="[–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã Mastercard]" class="h-4">
                        </div>
                    </div>
                </section>
                <div class="grid grid-cols-2 gap-4 pt-4">
                    <button id="cancel-edit-button" class="element-bg text-white py-3 rounded-xl font-semibold">–û–¢–ú–ï–ù–ò–¢–¨</button>
                    <button id="save-profile-button" class="solid-accent-button text-black py-3 rounded-xl font-semibold">–°–û–•–†–ê–ù–ò–¢–¨</button>
                </div>
             </main>
        </div>
    </div>

    <!-- MODALS -->
    <!-- Avatar Modal -->
    <div id="avatar-modal" class="modal-backdrop hidden">
        <div class="modal-panel modal-glow">
            <div class="flex-shrink-0 p-4"><h2 class="text-lg font-bold mb-1">–°–ú–ï–ù–ê –ê–í–ê–¢–ê–†–ê</h2><p class="text-secondary text-sm">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä</p></div>
            <div class="flex-grow overflow-y-auto px-4"><div id="avatar-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 content-start"></div></div>
            <input type="file" id="avatar-upload-input" class="hidden" accept="image/*">
            <div class="flex-shrink-0 grid grid-cols-2 gap-3 p-4 border-t border-gray-700">
                <button class="cancel-modal-button element-bg text-white py-2.5 rounded-xl font-semibold">–û–¢–ú–ï–ù–ò–¢–¨</button>
                <button id="save-avatar-button" class="solid-accent-button text-black py-2.5 rounded-xl font-semibold">–°–û–•–†–ê–ù–ò–¢–¨</button>
            </div>
        </div>
    </div>
    <!-- Gender Modal -->
    <div id="gender-modal" class="modal-backdrop hidden">
        <div class="modal-panel p-4">
            <h3 class="text-lg font-bold text-center mb-4">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª</h3>
            <div class="space-y-3">
                <button data-value="–ú—É–∂—Å–∫–æ–π" class="gender-option w-full element-bg p-3 rounded-xl">–ú—É–∂—Å–∫–æ–π</button>
                <button data-value="–ñ–µ–Ω—Å–∫–∏–π" class="gender-option w-full element-bg p-3 rounded-xl">–ñ–µ–Ω—Å–∫–∏–π</button>
                <button data-value="–î—Ä—É–≥–æ–π" class="gender-option w-full element-bg p-3 rounded-xl">–î—Ä—É–≥–æ–π</button>
            </div>
        </div>
    </div>
    <!-- Age/Calendar Modal -->
    <div id="age-modal" class="modal-backdrop hidden">
        <div class="modal-panel p-4">
            <div id="calendar-header" class="flex justify-between items-center mb-4">
                <button id="prev-month"><i data-lucide="chevron-left"></i></button>
                <div class="flex gap-2">
                    <select id="month-select" class="calendar-select"></select>
                    <select id="year-select" class="calendar-select"></select>
                </div>
                <button id="next-month"><i data-lucide="chevron-right"></i></button>
            </div>
            <div class="calendar-grid text-sm mb-4 text-secondary">
                <div>–í—Å</div><div>–ü–Ω</div><div>–í—Ç</div><div>–°—Ä</div><div>–ß—Ç</div><div>–ü—Ç</div><div>–°–±</div>
            </div>
            <div id="calendar-days" class="calendar-grid"></div>
            <div class="flex-shrink-0 grid grid-cols-2 gap-3 pt-4 border-t border-gray-700">
                <button class="cancel-modal-button element-bg text-white py-2.5 rounded-xl font-semibold">–û–¢–ú–ï–ù–ò–¢–¨</button>
                <button id="save-age-button" class="solid-accent-button text-black p-3 rounded-xl font-semibold">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    <!-- Country Modal -->
    <div id="country-modal" class="modal-backdrop hidden">
        <div class="modal-panel p-4">
            <h3 class="text-lg font-bold text-center mb-4">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É</h3>
            <input type="text" id="country-search" class="input-style mb-4" placeholder="–ü–æ–∏—Å–∫...">
            <div id="country-list" class="flex-grow overflow-y-auto country-list text-left"></div>
        </div>
    </div>
    <!-- PIN Modal -->
    <div id="pin-modal" class="modal-backdrop hidden">
        <div class="modal-panel p-6 space-y-4">
            <h3 id="pin-title" class="text-lg font-bold text-center">–°–æ–∑–¥–∞—Ç—å PIN-–∫–æ–¥</h3>
            <p id="pin-error" class="text-red-500 text-center text-sm hidden">PIN-–∫–æ–¥—ã –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç</p>
            <input type="password" id="pin-input" class="input-style text-center tracking-[1em]" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4">
            <input type="password" id="pin-confirm-input" class="input-style text-center tracking-[1em] hidden" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4">
            <div class="flex-shrink-0 grid grid-cols-2 gap-3 pt-4">
                <button class="cancel-modal-button element-bg text-white py-2.5 rounded-xl font-semibold">–û–¢–ú–ï–ù–ò–¢–¨</button>
                <button id="next-pin-button" class="solid-accent-button text-black p-3 rounded-xl font-semibold">–î–∞–ª–µ–µ</button>
            </div>
        </div>
    </div>
    <!-- Card Modal -->
    <div id="card-modal" class="modal-backdrop hidden">
        <div class="modal-panel p-6 space-y-4">
            <h3 class="text-lg font-bold text-center">–î–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã</h3>
            <input type="text" id="card-number" class="input-style" placeholder="–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã" maxlength="19">
            <div class="grid grid-cols-2 gap-4">
                <input type="text" id="card-expiry" class="input-style" placeholder="–ú–ú/–ì–ì" maxlength="5">
                <input type="text" id="card-cvc" class="input-style" placeholder="CVC" maxlength="4">
            </div>
             <div class="flex-shrink-0 grid grid-cols-2 gap-3 pt-4">
                <button class="cancel-modal-button element-bg text-white py-2.5 rounded-xl font-semibold">–û–¢–ú–ï–ù–ò–¢–¨</button>
                <button id="save-card-button" class="solid-accent-button text-black p-3 rounded-xl font-semibold">–ü—Ä–∏–≤—è–∑–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- DOM Elements ---
        const profilePage = document.getElementById('profile-page');
        const editProfilePage = document.getElementById('edit-profile-page');
        const editProfileButton = document.getElementById('edit-profile-button');
        const backToProfileButton = document.getElementById('back-to-profile-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const saveProfileButton = document.getElementById('save-profile-button');
        
        const avatarButton = document.getElementById('avatar-button');
        const toggleVisibilityButton = document.getElementById('toggle-visibility-button');

        const profileDetails = document.getElementById('profile-details');
        const profilePartner = document.getElementById('profile-partner');
        const profileStats = document.getElementById('profile-stats');
        const displayFullname = document.getElementById('display-fullname');
        const displayNickname = document.getElementById('display-nickname');
        const displayPartner = document.getElementById('display-partner');
        const displayGender = document.getElementById('display-gender');
        const displayAge = document.getElementById('display-age');
        const displayCountry = document.getElementById('display-country');
        const displayCountryFlag = document.getElementById('display-country-flag');

        const editFullname = document.getElementById('edit-fullname');
        const editNickname = document.getElementById('edit-nickname');
        const editEmail = document.getElementById('edit-email');
        const editPartner = document.getElementById('edit-partner');
        
        // --- State & Local Storage ---
        const USER_DATA_KEY = 'userProfileData';
        let selectedAvatarInModal = null;
        let selectedDateInCalendar = null;

        function loadUserData() {
            const data = localStorage.getItem(USER_DATA_KEY);
            const defaultData = {
                fullname: '–§–ò–û', nickname: 'kadetov', email: '–í–∞—à–∞ –ø–æ—á—Ç–∞',
                partner: '–Ω–∏–∫—Ç–µ–ª–µ–≥—Ä–∞–º', gender: '–ü–æ–ª', age: '–í–æ–∑—Ä–∞—Å—Ç',
                country: '–†–æ—Å—Å–∏—è', country_flag: 'üá∑üá∫',
                avatar: 'https://placehold.co/112x112/222/FFF?text=',
                avatarHistory: ['https://placehold.co/112x112/222/FFF?text='],
                isProfileVisible: true, pin: '', 
                card: { number: '', expiry: '', cvc: '' }
            };
            if (data) {
                const parsed = JSON.parse(data);
                return {...defaultData, ...parsed};
            }
            return defaultData;
        }

        function saveUserData(data) {
            localStorage.setItem(USER_DATA_KEY, JSON.stringify(data));
        }

        // --- UI Update Functions ---
        function updateUI() {
            const userData = loadUserData();
            displayFullname.textContent = userData.fullname;
            displayNickname.textContent = userData.nickname;
            displayPartner.textContent = userData.partner;
            displayGender.textContent = userData.gender;
            displayAge.textContent = userData.age;
            displayCountry.textContent = userData.country;
            displayCountryFlag.textContent = userData.country_flag;
            avatarButton.style.backgroundImage = `url('${userData.avatar}')`;
            
            editFullname.value = userData.fullname;
            editNickname.value = userData.nickname;
            editEmail.value = userData.email;
            editPartner.value = userData.partner;

            document.getElementById('open-gender-modal').textContent = userData.gender;
            document.getElementById('open-age-modal').textContent = userData.age;
            document.getElementById('open-country-modal').textContent = userData.country;

            const isVisible = userData.isProfileVisible;
            profileDetails.classList.toggle('hidden', !isVisible);
            profilePartner.classList.toggle('hidden', !isVisible);
            profileStats.classList.toggle('hidden', !isVisible);
            toggleVisibilityButton.setAttribute('data-lucide', isVisible ? 'eye' : 'eye-off');
            lucide.createIcons({ nodes: [toggleVisibilityButton] });
        }

        // --- Page Switching ---
        function showProfilePage() {
            profilePage.classList.remove('hidden');
            profilePage.classList.add('flex');
            editProfilePage.classList.add('hidden');
            editProfilePage.classList.remove('flex');
            updateUI();
        }

        function showEditProfilePage() {
            profilePage.classList.add('hidden');
            profilePage.classList.remove('flex');
            editProfilePage.classList.remove('hidden');
            editProfilePage.classList.add('flex', 'flex-col');
            updateUI();
        }

        // --- Generic Modal Logic ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            const panel = modal.querySelector('.modal-panel');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                modal.style.pointerEvents = 'auto';
                if(panel) panel.style.transform = 'translateY(0)';
            }, 10);
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            const panel = modal.querySelector('.modal-panel');
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0)';
            if(panel) panel.style.transform = 'translateY(100%)';
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.style.pointerEvents = 'none';
            }, 300);
        }

        // --- Modal Specific Logic ---
        // Avatar
        function initAvatarLogic() {
            const avatarUploadInput = document.getElementById('avatar-upload-input');
            const avatarGrid = document.getElementById('avatar-grid');
            
            function renderAvatarGrid() {
                const userData = loadUserData();
                avatarGrid.innerHTML = '';
                userData.avatarHistory.forEach(url => {
                    const div = document.createElement('div');
                    div.className = 'aspect-square rounded-full bg-cover bg-center cursor-pointer border-2 border-transparent';
                    if (url === selectedAvatarInModal) div.classList.add('avatar-selected');
                    div.style.backgroundImage = `url('${url}')`;
                    div.onclick = () => { selectedAvatarInModal = url; renderAvatarGrid(); };
                    avatarGrid.appendChild(div);
                });
                const uploadBtn = document.createElement('div');
                uploadBtn.className = 'aspect-square rounded-full border-2 border-dashed border-gray-600 flex flex-col items-center justify-center cursor-pointer p-2';
                uploadBtn.innerHTML = `<i data-lucide="plus" class="w-8 h-8 text-secondary"></i>`;
                uploadBtn.onclick = () => avatarUploadInput.click();
                avatarGrid.appendChild(uploadBtn);
                lucide.createIcons({nodes: [uploadBtn.querySelector('i')]});
            }

            avatarUploadInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (re) => {
                    const url = re.target.result;
                    const data = loadUserData();
                    if (!data.avatarHistory.includes(url)) data.avatarHistory.unshift(url);
                    selectedAvatarInModal = url;
                    saveUserData(data);
                    renderAvatarGrid();
                };
                reader.readAsDataURL(file);
            };
            document.getElementById('save-avatar-button').onclick = () => {
                if (selectedAvatarInModal) {
                    const data = loadUserData();
                    data.avatar = selectedAvatarInModal;
                    saveUserData(data);
                    updateUI();
                }
                closeModal('avatar-modal');
            };
            avatarButton.addEventListener('click', () => {
                selectedAvatarInModal = loadUserData().avatar;
                renderAvatarGrid();
                openModal('avatar-modal');
            });
        }
        
        // Gender
        document.getElementById('open-gender-modal').addEventListener('click', () => openModal('gender-modal'));
        document.querySelectorAll('.gender-option').forEach(btn => {
            btn.addEventListener('click', () => {
                const userData = loadUserData();
                userData.gender = btn.dataset.value;
                saveUserData(userData);
                updateUI();
                closeModal('gender-modal');
            });
        });

        // Calendar
        function initCalendarLogic() {
            const monthSelect = document.getElementById('month-select');
            const yearSelect = document.getElementById('year-select');
            const calendarDaysEl = document.getElementById('calendar-days');
            
            const monthNames = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];
            monthNames.forEach((name, i) => {
                monthSelect.options[i] = new Option(name, i);
            });

            const currentYear = new Date().getFullYear();
            for (let i = 0; i < 100; i++) {
                yearSelect.options[i] = new Option(currentYear - i, currentYear - i);
            }

            function renderCalendar() {
                calendarDaysEl.innerHTML = '';
                const month = parseInt(monthSelect.value);
                const year = parseInt(yearSelect.value);

                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 0; i < firstDay; i++) calendarDaysEl.insertAdjacentHTML('beforeend', `<div></div>`);
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    dayEl.textContent = i;

                    if (selectedDateInCalendar &&
                        i === selectedDateInCalendar.getDate() &&
                        month === selectedDateInCalendar.getMonth() &&
                        year === selectedDateInCalendar.getFullYear()) {
                        dayEl.classList.add('selected');
                    }

                    dayEl.addEventListener('click', () => {
                        selectedDateInCalendar = new Date(year, month, i);
                        renderCalendar();
                    });
                    calendarDaysEl.appendChild(dayEl);
                }
            }
            
            monthSelect.addEventListener('change', renderCalendar);
            yearSelect.addEventListener('change', renderCalendar);
            document.getElementById('open-age-modal').addEventListener('click', () => { 
                selectedDateInCalendar = null;
                const today = new Date();
                monthSelect.value = today.getMonth();
                yearSelect.value = today.getFullYear();
                renderCalendar(); 
                openModal('age-modal'); 
            });
            document.getElementById('prev-month').addEventListener('click', () => { monthSelect.value = (parseInt(monthSelect.value) + 11) % 12; renderCalendar(); });
            document.getElementById('next-month').addEventListener('click', () => { monthSelect.value = (parseInt(monthSelect.value) + 1) % 12; renderCalendar(); });
            
            document.getElementById('save-age-button').addEventListener('click', () => {
                if (!selectedDateInCalendar) return;
                const today = new Date();
                let age = today.getFullYear() - selectedDateInCalendar.getFullYear();
                const m = today.getMonth() - selectedDateInCalendar.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < selectedDateInCalendar.getDate())) age--;
                const userData = loadUserData();
                userData.age = age;
                saveUserData(userData);
                updateUI();
                closeModal('age-modal');
            });
        }

        // Country
        function initCountryLogic() {
            const countryListEl = document.getElementById('country-list');
            const countrySearchEl = document.getElementById('country-search');
            let countries = [];
            async function fetchCountries() {
                 countries = [{"name":"–†–æ—Å—Å–∏—è","flag":"üá∑üá∫"},{"name":"–°–®–ê","flag":"üá∫üá∏"},{"name":"–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω","flag":"üá∞üáø"},{"name":"–ë–µ–ª–∞—Ä—É—Å—å","flag":"üáßüáæ"},{"name":"–£–∫—Ä–∞–∏–Ω–∞","flag":"üá∫üá¶"},{"name":"–ì–µ—Ä–º–∞–Ω–∏—è","flag":"üá©üá™"}]; // Add more countries
                 renderCountries();
            }
            function renderCountries(filter = '') {
                countryListEl.innerHTML = '';
                const filtered = countries.filter(c => c.name.toLowerCase().includes(filter.toLowerCase()));
                filtered.forEach(country => {
                    const countryEl = document.createElement('div');
                    countryEl.className = 'p-2 hover:bg-[#333] cursor-pointer rounded-lg flex items-center';
                    countryEl.innerHTML = `<span class="mr-4">${country.flag}</span><span>${country.name}</span>`;
                    countryEl.addEventListener('click', () => {
                        const userData = loadUserData();
                        userData.country = country.name;
                        userData.country_flag = country.flag;
                        saveUserData(userData);
                        updateUI();
                        closeModal('country-modal');
                    });
                    countryListEl.appendChild(countryEl);
                });
            }
            document.getElementById('open-country-modal').addEventListener('click', () => openModal('country-modal'));
            countrySearchEl.addEventListener('input', (e) => renderCountries(e.target.value));
            fetchCountries();
        }

        // PIN & Card
        function initSecurityLogic() {
            // PIN
            const pinModal = document.getElementById('pin-modal');
            const pinTitle = document.getElementById('pin-title');
            const pinInput = document.getElementById('pin-input');
            const pinConfirmInput = document.getElementById('pin-confirm-input');
            const pinError = document.getElementById('pin-error');
            const nextPinButton = document.getElementById('next-pin-button');
            let pinStep = 1;
            let firstPin = '';

            function resetPinModal() {
                pinStep = 1;
                firstPin = '';
                pinTitle.textContent = '–°–æ–∑–¥–∞—Ç—å PIN-–∫–æ–¥';
                pinInput.value = '';
                pinConfirmInput.value = '';
                pinInput.classList.remove('hidden');
                pinConfirmInput.classList.add('hidden');
                pinError.classList.add('hidden');
                nextPinButton.textContent = '–î–∞–ª–µ–µ';
            }

            document.getElementById('open-pin-modal').addEventListener('click', () => {
                resetPinModal();
                openModal('pin-modal');
            });

            nextPinButton.addEventListener('click', () => {
                pinError.classList.add('hidden');
                pinInput.classList.remove('error');
                pinConfirmInput.classList.remove('error');

                if (pinStep === 1) {
                    if (pinInput.value.length !== 4) {
                        pinInput.classList.add('error');
                        return;
                    }
                    firstPin = pinInput.value;
                    pinStep = 2;
                    pinTitle.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ PIN-–∫–æ–¥';
                    pinInput.classList.add('hidden');
                    pinConfirmInput.classList.remove('hidden');
                    pinConfirmInput.focus();
                    nextPinButton.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                } else { // pinStep === 2
                    if (firstPin !== pinConfirmInput.value) {
                        pinError.classList.remove('hidden');
                        pinConfirmInput.classList.add('error');
                        return;
                    }
                    const data = loadUserData();
                    data.pin = firstPin;
                    saveUserData(data);
                    closeModal('pin-modal');
                }
            });

            // Card
            const cardNumber = document.getElementById('card-number');
            const cardExpiry = document.getElementById('card-expiry');
            const cardCvc = document.getElementById('card-cvc');
            document.getElementById('open-card-modal').addEventListener('click', () => openModal('card-modal'));
            
            cardNumber.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/\D/g, '').replace(/(\d{4})(?=\d)/g, '$1 ');
            });
            cardExpiry.addEventListener('input', (e) => {
                let input = e.target.value.replace(/\D/g, '');
                if (input.length > 2) input = input.slice(0, 2) + '/' + input.slice(2, 4);
                e.target.value = input;
            });

            document.getElementById('save-card-button').addEventListener('click', () => {
                const data = loadUserData();
                data.card = {
                    number: cardNumber.value,
                    expiry: cardExpiry.value,
                    cvc: cardCvc.value,
                };
                saveUserData(data);
                closeModal('card-modal');
            });
        }
        
        // --- Global Event Listeners & Init ---
        editProfileButton.addEventListener('click', showEditProfilePage);
        backToProfileButton.addEventListener('click', showProfilePage);
        cancelEditButton.addEventListener('click', showProfilePage);

        saveProfileButton.addEventListener('click', () => {
            const userData = loadUserData();
            userData.fullname = document.getElementById('edit-fullname').value;
            userData.nickname = document.getElementById('edit-nickname').value;
            userData.email = document.getElementById('edit-email').value;
            userData.partner = document.getElementById('edit-partner').value;
            saveUserData(userData);
            showProfilePage();
        });
        
        toggleVisibilityButton.addEventListener('click', () => {
            const userData = loadUserData();
            userData.isProfileVisible = !userData.isProfileVisible;
            saveUserData(userData);
            updateUI();
        });

        document.querySelectorAll('.modal-backdrop').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal(modal.id);
            });
        });
        document.querySelectorAll('.cancel-modal-button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modal = e.target.closest('.modal-backdrop');
                if(modal) closeModal(modal.id);
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            updateUI();
            initAvatarLogic();
            initCalendarLogic();
            initCountryLogic();
            initSecurityLogic();
        });
    </script>
</body>
</html>
